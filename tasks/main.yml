---
- include: ip_detect.yml
- include: yum.yml
- include: firewall.yml

- name: Start the swarm manager
  when:
    - inventory_hostname in groups['swarm_managers']
  docker:
    name: swarm_manager
    image: swarm
    state: reloaded
    restart_policy: always
    expose: 4000
    ports:
      - "4000:4000"
    command: >
      manage -H :4000 --replication
      --advertise {{ host_ip.stdout }}:4000
      consul://{{ consul_ip.stdout }}:8500/docker
    docker_api_version: 1.22
  tags: docker

- name: Start the swarm nodes
  when:
    - inventory_hostname in groups['swarm_agents']
  docker:
    name: swarm_node
    image: swarm
    state: reloaded
    restart_policy: always
    command: >
      join --advertise={{ host_ip.stdout }}:2375
      consul://{{ consul_ip.stdout }}:8500/docker
    docker_api_version: 1.22
  tags: docker
